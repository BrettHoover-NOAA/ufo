obs space:
  name: aircraft_prepbufr
  obsdatain:
    engine:
      type: H5File
    obsgrouping:
      group variables: [station_id]
      sort variable: air_pressure
      sort order: descending
  obsdataout:
    engine:
      type: H5File
      allow overwrite: true
  _source: noaa
  simulated variables: [eastward_wind, northward_wind, air_temperature]
obs operator:
  name: VertInterp
obs filters:
# Observation Range Sanity Check
- filter: Bounds Check
  filter variables:
  - name: air_temperature
  minvalue: 195
  maxvalue: 327
  action:
    name: reject
- filter: Bounds Check
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  minvalue: -130
  maxvalue: 130
  action:
    name: reject
#
- filter: Bounds Check
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  test variables:
  - name: Velocity@ObsFunction
  maxvalue: 130.0
  action:
    name: reject
# Reject when pressure is larger than 600 mb.
- filter: Bounds Check
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  - name: air_temperature
  test variables:
  - name: MetaData/air_pressure
  maxvalue: 60000
  action:
    name: reject
- filter: Bounds Check
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  test variables:
  - name: WindDirAngleDiff@ObsFunction
    options:
      minimum_uv: 3.5
  maxvalue: 50.0
  action:
    name: reject
  defer to post: true

# PreQC
- filter: PreQC
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  - name: air_temperature
  maxvalue: 2
  action:
    name: reject

# temperature
# Begin by assigning all ObsError to a constant value. These will get overwritten for specific types.
- filter: Perform Action
  filter variables:
  - name: air_temperature
  action:
    name: assign error
    error parameter: 2.0             # 2.0 K
# Assign the initial observation error, based on pressure (for AIREP/ACARS; itype=130)
- filter: Perform Action
  filter variables:
  - name: air_temperature
  action:
    name: assign error
    error function:
      name: ObsErrorModelStepwiseLinear@ObsFunction
      options:
        xvar:
          name: MetaData/air_pressure
        xvals: [100000, 95000, 90000, 85000, 80000]
        errors: [2.5, 2.3, 2.1, 1.9, 1.7]
  where:
  - variable:
      name: ObsType/air_temperature
    is_in: 130
# Assign the initial observation error, based on pressure (for AMDAR and MDCRS; itype=131,133)
- filter: Perform Action
  filter variables:
  - name: air_temperature
  action:
    name: assign error
    error function:
      name: ObsErrorModelStepwiseLinear@ObsFunction
      options:
        xvar:
          name: MetaData/air_pressure
        xvals: [100000, 95000, 90000, 85000, 80000]
        errors: [1.4706, 1.3529, 1.2353, 1.1176, 1.0]
  where:
  - variable:
      name: ObsType/air_temperature
    is_in: 131,133
# Assign the initial observation error, based on pressure (for RECON aircraft; itype=132)
- filter: Perform Action
  filter variables:
  - name: air_temperature
  action:
    name: assign error
    error function:
      name: ObsErrorModelStepwiseLinear@ObsFunction
      options:
        xvar:
          name: MetaData/air_pressure
        xvals: [100000, 95000, 90000, 85000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3200, 2000, 1000]
        errors: [1.2, 1.1, 0.9, 0.8, 0.8, 0.9, 1.2, 1.2, 1.0, 0.8, 0.8, 0.9, 0.95, 1.0, 1.25, 1.5]
  where:
  - variable:
      name: ObsType/air_temperature
    is_in: 132

# wind
- filter: Perform Action
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  action:
    name: assign error
    error parameter: 3.0   

- filter: Perform Action
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  action:
    name: assign error
    error parameter: 3.6             # 3.6 m/s
  where:
  - variable:
      name: ObsType/eastward_wind
    is_in: 230

# Assign intial ObsError specific to AMDAR
- filter: Perform Action
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  action:
    name: assign error
    error parameter: 3.0             # 3.0 m/s
  where:
  - variable:
      name: ObsType/eastward_wind
    is_in: 231

# Assign intial ObsError specific to MDCRS
- filter: Perform Action
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  action:
    name: assign error
    error parameter: 2.5             # 2.5 m/s
  where:
  - variable:
      name: ObsType/eastward_wind
    is_in: 233

# Assign the initial ObsError, based on height/pressure for RECON aircraft
- filter: Perform Action
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  action:
    name: assign error
    error function:
      name: ObsErrorModelStepwiseLinear@ObsFunction
      options:
        xvar:
          name: MetaData/air_pressure
        xvals: [70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000]
        errors: [2.4, 2.5, 2.6, 2.7, 2.8, 2.95, 3.1, 3.25, 3.4, 3.175, 2.95, 2.725, 2.5, 2.6, 2.7]
  where:
  - variable:
      name: ObsType/eastward_wind
    is_in: 232

# Background Check
- filter: Background Check
  filter variables:
  - name: air_temperature
  threshold: 3.0
  absolute threshold: 6.0
  action:
    name: reject
- filter: Background Check
  filter variables:
  - name: eastward_wind
  - name: northward_wind
  threshold: 3.0
  absolute threshold: 10.0
  action:
    name: reject
